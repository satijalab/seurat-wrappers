---
title: "Analyzing Seurat data using fastTopics"
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    df_print: kable
    self_contained: no
---

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120,tidy = TRUE,
                      tidy.opts = list(width.cutoff = 95))
```

This vignette illustrates the use of the [fastTopics][fasttopics]
Seurat wrapper to analyze a Seurat data set. This vignette is intended
only to introduce the basic fastTopics interface for Seurat
objects. For more detailed guidance on analyzing single-cell RNA-seq
data using a topic model, please see the
[fastTopics vignettes][fasttopics-vignettes].

If you find the **fastTopics** package useful for your work, please
cite:

> *Visualizing the structure of RNA-seq expression data using grade of
> membership models.*
>
> K. K. Dey, C. J. Hsiao and M. Stephens.
>
> PLoS Genetics, 2017.
>
> doi: [10.1371/journal.pgen.1006599](https://doi.org/10.1371/journal.pgen.1006599)

and

> *Non-negative matrix factorization algorithms greatly improve topic
> model fits.*
>
> P. Carbonetto, A. Sarkar, Z. Wang and M. Stephens.
>
> arXiv, 2021
>
> [arXiv 2105.13440](https://arxiv.org/abs/2105.13440)

If you use the **de_analysis** function in fastTopics, please cite:

> *Interpreting structure in sequence count data with differential
> expression analysis allowing for grades of membership.*
> 
> P. Carbonetto, K. Luo, A. Sarkar, A. Hung, K. Tayeb, S. Pott and
> M. Stephens
>
> bioRxiv, 2023.
>
> doi: [10.1101/2023.03.03.531029](https://doi.org/10.1101/2023.03.03.531029)

To begin, load the packages we will need to perform the analysis.

```{r load-pkgs, message=FALSE, warning=FALSE}
library(Seurat)
library(SeuratData)
library(SeuratWrappers)
library(fastTopics)
library(cowplot)
```

Set the seed so that the results can be reproduced.

```{r set-seed}
set.seed(1)
```

Load (and install if necessary) the PBMC 3k data set containing
transcription profiles for 2,700 cells.

```{r load-data, warning=FALSE}
InstallData("pbmc3k")
data(pbmc3k)
dim(GetAssayData(pbmc3k))
```

Fit the multinomial topic model to the raw UMI counts. *No data
preprocessing or gene filtering is needed.* It may take several
minutes to fit the model.

```{r fit-model, results="hide", message=FALSE, cache=TRUE}
pbmc3k <- FitTopicModel(pbmc3k,k = 6)
```

To fit a topic model, we had to choose $K$, the number of topics.
Here, we chose $K = 6$ topics. In most settings, a good choice of $K$
will not be known in advance, so you will likely want to explore the
different settings of $K$.

This first plot shows the cells projected onto the top two PCs of the
topic proportions.

```{r pca-1, fig.width=4.5, fig.height=3}
Idents(pbmc3k) <- pbmc3k$seurat_annotations
DimPlot(pbmc3k,reduction = "pca_topics",pt.size = 1) +
  theme_cowplot(font_size = 10)
```

Compare this with the top two PCs of the normalized and scaled counts:

```{r pca-2, fig.width=4.5, fig.height=3, message=FALSE}
pbmc3k <- FindVariableFeatures(pbmc3k)
pbmc3k <- NormalizeData(pbmc3k)
pbmc3k <- ScaleData(pbmc3k)
pbmc3k <- RunPCA(pbmc3k)
DimPlot(pbmc3k,reduction = "pca",pt.size = 1) +
  theme_cowplot(font_size = 10)
```

The fitted topic model---a "multinom_topic_model" object---is stored
in the "misc" slot:

```{r extract-fit}
fit <- Misc(Reductions(pbmc3k,"multinom_topic_model"))$fit
```

Once the topic model has been extracted from the Seurat object, many
fastTopics functions can be used for downstream analysis and
visualization. For example, we can create a "Structure plot" to
visualize all $K$ dimensions of the topic model simultaneously:

```{r structure-plot, fig.width=7.5, fig.height=1.75, results="hide", message=FALSE}
structure_plot(fit,grouping = Idents(pbmc3k),gap = 25)
```

In the Structure plot, each position along the x-axis is a cell, and
the bar heights at each positioin correspond to topic proportions for
that cell.

From this plot, we observe that topic 3 (green) closely corresponds to
B cells. Topics 1 (red) and 4 (purple) also correspond fairly well to
the two types of monocytes, but there is also some overlap in the
topics; in particular, the purple topic is shared by both types of
monocytes. This suggests that expression in these two types of cells
is less distinguishable than B cells vs. other cell types.

Topic 5 (orange) corresponds closely to natural killer (NK) cells.
Topic 2 (blue) appears to capture biological processes common to T
cells. Interestingly, CD8+ T cells have characteristics of both NK
cells and T cells---these are T cells that sometimes become
``NK-like''---and this is reflected in the topic model by assigning
membership to both topics 2 and 5 (blue and orange).

The other cell types (platelets, dendritic cells), perhaps because
they are less abundant and/or difficult to distinguish from the other
cell types, are represented as combinations of the topics for the
other cell types.

Topic 6 is present in almost all cells to varying degrees, and
therefore its biological interpretation is not at all clear from the
cell labeling.

Motivate the DE analysis using the topic model:

```{r de-analysis, cache=TRUE}
pbmc3k <- PerformGoMDEAnalysis(pbmc3k,pseudocount = 0.1,
                               control = list(ns = 1e4,nc = 4))
```

Now we can create volcano plots to visualize the results of the DE
analysis.

B cells:

```{r volcano-plot-b-cells, fig.height=4, fig.width=4.5}
de <- Misc(Reductions(pbmc3k,"multinom_topic_model"))$de
volcano_plot(de,k = 3)
```

CD14+ monocytes:

```{r volcano-plot-cd14, fig.height=4, fig.width=4.5}
volcano_plot(de,k = 1)
```

NK cells:

```{r volcano-plot-nk, fig.height=4, fig.width=4.5}
volcano_plot(de,k = 5,ymax = 50)
```

Ribosomal protein genes:

```{r volcano-plot-rp-genes, fig.height=4, fig.width=4.5}
volcano_plot(de,k = 6,ymax = 50)
```

This is the version of R and the packages that were used to generate
these results:

```{r session-info}
sessionInfo()
```

[fasttopics]:  https://github.com/stephenslab/fastTopics
[fasttopics-vignettes]:  https://stephenslab.github.io/fastTopics/articles
