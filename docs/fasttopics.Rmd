---
title: "Analyzing Seurat data using fastTopics"
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    df_print: kable
    self_contained: no
---

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120,tidy = TRUE,
                      tidy.opts = list(width.cutoff = 95))
```

This vignette illustrates the use of the [fastTopics][fasttopics]
Seurat wrapper to analyze a Seurat data set. This vignette is intended
only to introduce the basic Seurat interface, and for more detailed
guidance please visit the [fastTopics vignettes][fasttopics-vignettes].

If you find the **fastTopics** package useful for your work, please
cite:

*Visualizing the structure of RNA-seq expression data using grade of
membership models.*<br>
K. K. Dey, C. J. Hsiao and M. Stephens.<br>
PLoS Genetics, 2017.<br>
doi: [10.1371/journal.pgen.1006599](https://doi.org/10.1371/journal.pgen.1006599)

and

*Non-negative matrix factorization algorithms greatly improve topic
model fits.*<br>
P. Carbonetto, A. Sarkar, Z. Wang and M. Stephens.<br>
arXiv, 2021.<br>
[arXiv 2105.13440](https://arxiv.org/abs/2105.13440)

If you use the **de_analysis** function in **fastTopics**, please cite:

*Interpreting structure in sequence count data with differential
expression analysis allowing for grades of membership.*<br>
P. Carbonetto, K. Luo, A. Sarkar, A. Hung, K. Tayeb, S. Pott and
M. Stephens.<br>
bioRxiv, 2023.<br>
doi: [10.1101/2023.03.03.531029](https://doi.org/10.1101/2023.03.03.531029)

To begin, load the packages we will need to perform the analysis.

```{r load-pkgs, message=FALSE, warning=FALSE}
library(Seurat)
library(SeuratData)
library(SeuratWrappers)
library(fastTopics)
library(cowplot)
```

Set the seed so that the results can be reproduced.

```{r set-seed}
set.seed(1)
```

Load (and install if necessary) the PBMC 3k data set containing
transcription profiles for 2,700 cells.

```{r load-data, warning=FALSE}
InstallData("pbmc3k")
data(pbmc3k)
dim(GetAssayData(pbmc3k))
```

Fit the multinomial topic model to the raw UMI counts. *No data
preprocessing or gene filtering is needed.* Note it may take several
minutes to fit the model.

```{r fit-model, results="hide", message=FALSE, cache=TRUE}
pbmc3k <- FitTopicModel(pbmc3k,k = 6)
```

To fit a topic model, we had to choose $K$, the number of topics.
Here, we chose $K = 6$ topics. In most settings, a good choice of $K$
will not be known in advance, so you will likely want to explore the
different settings of $K$.

This first plot shows the cells projected onto the top two PCs of the
topic proportions.

```{r pca-1, fig.width=4.5, fig.height=3}
Idents(pbmc3k) <- pbmc3k$seurat_annotations
DimPlot(pbmc3k,reduction = "pca_topics",pt.size = 1) +
  theme_cowplot(font_size = 10)
```

Compare this with the top two PCs of the normalized and scaled counts:

```{r pca-2, fig.width=4.5, fig.height=3, message=FALSE}
pbmc3k <- FindVariableFeatures(pbmc3k)
pbmc3k <- NormalizeData(pbmc3k)
pbmc3k <- ScaleData(pbmc3k)
pbmc3k <- RunPCA(pbmc3k)
DimPlot(pbmc3k,reduction = "pca",pt.size = 1) +
  theme_cowplot(font_size = 10)
```

The fitted topic model---a "multinom_topic_model" object---is stored
in the "misc" slot:

```{r extract-fit}
fit <- Misc(Reductions(pbmc3k,"multinom_topic_model"))$fit
```

Once the topic model has been extracted from the Seurat object, a
variety of fastTopics functions can be used for downstream analysis
and visualization. For example, we can create a "Structure plot" to
visualize all $K$ dimensions of the topic model simultaneously:

```{r structure-plot, fig.width=7.5, fig.height=1.75, results="hide", message=FALSE}
structure_plot(fit,grouping = Idents(pbmc3k),gap = 25)
```

In the Structure plot, each position along the x-axis is a cell and
the bar heights at each position correspond to topic proportions for
that cell.

Looking closely at the Structure plot, we observe that topic 3 (green)
closely corresponds to B cells. Topics 1 (red) and 4 (purple) also
correspond fairly well to the two types of monocytes, but there is
also some overlap in the topics; in particular, the purple topic is
shared by both types of monocytes. This suggests that expression in
these two types of cells is less distinguishable than B cells
vs. other cell types.

Topic 5 (orange) corresponds closely to natural killer (NK) cells.
Topic 2 (blue) appears to capture biological processes common to T
cells. Interestingly, CD8+ T cells have characteristics of both NK
cells and T cells---these are T cells that sometimes become
``NK-like''---and this is reflected in the topic model by assigning
membership to both topics 2 and 5.

The other cell types (platelets, dendritic cells), perhaps because
they are less abundant and/or difficult to distinguish from the other
cell types, are represented as combinations of the topics for the
other cell types.

Topic 6 is present in almost all cells to varying degrees, and
therefore its biological interpretation is not at all clear from the
cell labeling.

Having compared the topic model with the existing cell-type labels,
our next aim is to annotate the topics by identifying genes that are
distinctive to each topic. To do this, we perform a "grade of
membership" differential expression analysis (GoM DE):

```{r de-analysis, message=FALSE, cache=TRUE}
pbmc3k <- PerformGoMDEAnalysis(pbmc3k,pseudocount = 0.1,
                               control = list(ns = 1e4,nc = 4))
```

Note this step may take some time to run on your computer---10
minutes, or perhaps more. This is an expensive step because posterior
estimation is performed through Monte Carlo simulation.

Once the differential expression analysis is complete, we can use a
"volcano plot" to visualize the results. For example, this is the
volcano plot for topic 3:

```{r volcano-plot-b-cells, fig.height=3.3, fig.width=4}
de <- Misc(Reductions(pbmc3k,"multinom_topic_model"))$de
volcano_plot(de,k = 3,ymax = 100)
```

The volcano plot shows the log-fold change (LFC) on the x-axis and
some measure of statistical support on the y-axis. For the measure of
support, we use the posterior *z*-score (posterior mean divided by
posterior standard deviation). To report which LFCs are significant,
instead of a *p*-value we give the local false sign rate (lfsr), which
is typically slightly more conservative than a *p*-value. Note the
LFC is defined with the base-2 log by convention.

Typically, the most interesting genes are found on the right-hand side
of the volcano plot---the genes with the largest LFCs. Indeed, *CD79A*
is on the far right-hand side of the plot, which aligns with our
previous finding that topic 3 corresponds closely to B cells.

Similarly, NK genes such as *NKG7* and *GNLY* emerge on the right-hand
side of the volcano plot for topic 1:

```{r volcano-plot-nk, fig.height=3.3, fig.width=4}
volcano_plot(de,k = 5,ymax = 50)
```

Topic 6 captures continuous structure and is present in almost all
cells, and the GoM DE results for topic 6 show a striking enrichment
of ribosome-associated genes:

```{r volcano-plot-rp-genes, fig.height=3.3, fig.width=4}
volcano_plot(de,k = 6,ymax = 50)
```

This is the version of R and the packages that were used to generate
these results:

```{r session-info}
sessionInfo()
```

[fasttopics]:  https://github.com/stephenslab/fastTopics
[fasttopics-vignettes]:  https://stephenslab.github.io/fastTopics/articles
